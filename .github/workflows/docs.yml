name: Build ConvoCore Docs Site

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # Checkout repository
      - name: Checkout
        uses: actions/checkout@v4

      # Install Doxygen, Graphviz, rsync
      - name: Install Doxygen and tools
        run: |
          sudo apt-get update
          sudo apt-get install -y doxygen graphviz rsync

      # Generate Doxygen documentation
      - name: Build Doxygen API
        run: doxygen Doxyfile

      # Copy Doxygen output into Docusaurus static folder
      - name: Copy Doxygen HTML into Docusaurus static path
        run: |
          rm -rf website_docusaurus/static/convocore/api
          mkdir -p website_docusaurus/static/convocore/api
          rsync -a Docs/html/ website_docusaurus/static/convocore/api/
      - name: Ensure copied API contains class pages
        run: |
          test -f website_docusaurus/static/convocore/api/annotated.html
          test -f website_docusaurus/static/convocore/api/classes.html

      - name: Ensure Doxygen produced class pages
        run: |
          test -f Docs/html/annotated.html
          test -f Docs/html/classes.html

      # Hard fail if API did not generate correctly
      - name: Ensure API index exists
        run: test -f website_docusaurus/static/convocore/api/index.html

      # Build Docusaurus site
      - name: Build Docusaurus
        working-directory: website_docusaurus
        run: |
          npm ci
          npm run build

      # Add CNAME for custom domain
      - name: Add CNAME for custom domain
        run: echo "docs.wolfstaginteractive.com" > website_docusaurus/build/CNAME

      # Deploy to gh-pages
      - name: Deploy to gh-pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: website_docusaurus/build
          publish_branch: gh-pages